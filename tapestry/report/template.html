<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Tapestry: quality assessment for small genome assemblies">
  <meta name="author" content="Tapestry">
  
  <title>Tapestry Report</title>
  
  <style type="text/css">{{ include_file('static/bootstrap.min.css') }}</style>
  <style type="text/css">{{ include_file('static/bootstrap-table.min.css') }}</style>
  <script type="text/javascript">{{ include_file('static/jquery-3.3.1.min.js') }}</script>
  <script type="text/javascript">{{ include_file('static/bootstrap.min.js') }}</script>
  <script type="text/javascript">{{ include_file('static/bootstrap-table.min.js') }}</script>
  <script type="text/javascript">{{ include_file('static/d3.min.js') }}</script>
  
  <script type="text/javascript">
    var contigs = {{ contigs }};
    var threads = {{ threads }};
  </script>
</head>

<body>
  <div class="mainpage">
    <h1 id="page_title">Tapestry Report</h1>

    <noscript>
      <div class="alert alert-danger">
        <h4>JavaScript Disabled</h4>
        <p>
          Tapestry uses JavaScript, but it looks like
          you have JavaScript disabled in your web browser.
          Please enable JavaScript to view the full report.
        </p>
      </div>
    </noscript>

    <div id="contig_length_plot">
      <h2 id="page_title">Contig Lengths</h2>
      <script>
        var plotWidth = 600;
        var plotHeight = 300;
        var xScale = d3.scaleLinear()
                       .domain([0, d3.max(contigs, function(d) { return d.length; })])
                       .range([0, plotWidth]);

        var yScale = d3.scaleBand()
                       .domain(d3.range(contigs.length))
                       .rangeRound([0, plotHeight])
                       .paddingInner(0.05);

        var svg = d3.select("#contig_length_plot")
                    .append("svg")
                    .attr("width", plotWidth)
                    .attr("height", plotHeight);

        svg.selectAll("rect")
            .data(contigs, function(d) { return d.name })
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", function(d, i) { return yScale(i); })
            .attr("height", yScale.bandwidth())
            .attr("width", function(d) { return xScale(d.length); })
            .attr("fill", "blue");
      </script>
    </div>

    <div id="threads_plot">
      <h2 id="page_title">Contig Threads</h2>
      <script>
        var plotWidth = 1500;
        var plotHeight = 300;

        var dropdown = d3.select('#threads_plot')
          .append('select')
          .attr('class','select')
          .on('change',onchange);

        var options = dropdown
          .selectAll('option')
          .data(Object.keys(threads))
          .enter()
          .append('option')
          .text(function (d) { return d; });

        var contig_threads = threads[d3.select('select').property('value')];

        var xScale = d3.scaleLinear()
                       .domain([d3.min(contig_threads, function(d) { return d[1]; }),
                                d3.max(contig_threads, function(d) { return d[5]; }) ])
                       .range([0, plotWidth]);
        
        var yScale = d3.scaleLinear()
                               .domain([0, 100000])
                               .range([0, plotHeight]);

        function onchange() {
          selectValue = d3.select('select').property('value')
          d3.select('#threads_plot')
            .append('p')
            .text(selectValue + ' is the last selected option.')
        };

        var svg = d3.select("#threads_plot")
                    .append("svg")
                    .attr("width", plotWidth)
                    .attr("height", plotHeight);

        var alignments = svg.selectAll("line")
            .data(contig_threads)
            .enter()

        var mq_opacity = function(mq) { return mq/60 }
        
        alignments.append("line")
            .attr("x1", function(d) { return xScale(d[2]); })
            .attr("x2", function(d) { return xScale(d[3]); })
            .attr("y1", function(d) { return yScale(40000); })
            .attr("y2", function(d) { return yScale(60000); })
            .style("stroke-opacity", function(d) { return mq_opacity(d[6]) })
            .style("stroke", "blue")

        alignments.append("line")
            .attr("x1", function(d) { return xScale(d[1]); })
            .attr("x2", function(d) { return xScale(d[2]); })
            .attr("y1", function(d) { return yScale(40000-d[0]); })
            .attr("y2", function(d) { return yScale(40000); })
            .style("stroke-opacity", function(d) { return mq_opacity(d[6]) })
            .style("stroke", "orange")

        alignments.append("line")
            .attr("x1", function(d) { return xScale(d[3]); })
            .attr("x2", function(d) { return xScale(d[5]); })
            .attr("y1", function(d) { return yScale(60000); })
            .attr("y2", function(d) { return yScale(60000+d[4]); })
            .style("stroke-opacity", function(d) { return mq_opacity(d[6]) })
            .style("stroke", "pink")
      </script>
    </div>

    <div id="contig_report">
      <h2>Contig Report</h2>

      <table id="table" data-sort-name="cluster" data-sort-order="asc">
        <thead>
          <tr>
            <th data-field="cluster" data-sortable="true">Cluster</th>
            <th data-field="name" data-sortable="true">Contig</th>
            <th data-field="length" data-sortable="true">Length (bp)</th>
            <th data-field="gc" data-sortable="true">GC Content (%)</th>
            <th data-field="tel_start" data-sortable="true">Start Telomeres</th>
            <th data-field="tel_end" data-sortable="true">End Telomeres</th>
          </tr>
        </thead>
      </table>

      <script>
        var $table = $('#table')
        $(function() {
          $table.bootstrapTable({data: contigs})
        })
      </script>
    </div>
  </div>
</body>
</html>
