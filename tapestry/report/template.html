<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Tapestry: quality assessment for small genome assemblies">
  <meta name="author" content="Tapestry">
  
  <title>Tapestry Report</title>
  
  <style type="text/css">{{ include_file('static/bootstrap.min.css') }}</style>
  <style type="text/css">{{ include_file('static/bootstrap-table.min.css') }}</style>
</head>

<body>
  <div class="mainpage">
    <h1 id="page_title">Tapestry Report</h1>

    <noscript>
      <div class="alert alert-danger">
        <h4>JavaScript Disabled</h4>
        <p>
          Tapestry uses JavaScript, but it looks like
          you have JavaScript disabled in your web browser.
          Please enable JavaScript to view the full report.
        </p>
      </div>
    </noscript>

    <div id="contig_length_plot">
      <h2 id="page_title">Assembly Overview</h2>
    </div>

    <div id="read_alignment_plot">
      <h2 id="page_title">Contig Details</h2>
    </div>

    <div id="contig_alignment_plot"></div>

    <div id="contig_report">
      <h2>Contig Report</h2>

      <table id="table" data-sort-name="cluster" data-sort-order="asc">
        <thead>
          <tr>
            <th data-field="cluster" data-sortable="true">Cluster</th>
            <th data-field="name" data-sortable="true">Contig</th>
            <th data-field="length" data-sortable="true">Length (bp)</th>
            <th data-field="gc" data-sortable="true">GC Content (%)</th>
            <th data-field="tel_start" data-sortable="true">Start Telomeres</th>
            <th data-field="tel_end" data-sortable="true">End Telomeres</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
<script type="text/javascript">
{{ include_file('static/jquery-3.3.1.min.js') }}
{{ include_file('static/bootstrap.min.js') }}
{{ include_file('static/bootstrap-table.min.js') }}
{{ include_file('static/d3.min.js') }}

var windowsize = {{ windowsize }};
var contigs = {{ contigs }};
var read_alignments = {{ read_alignments }};
var contig_alignments = {{ contig_alignments }};
var ploidys = {{ ploidys }};

var max_read_depth = 0;
var max_contig_depth = 0;
var contig_domains = {};

for (var key in read_alignments) {
    var max_contig_read_depth = d3.max(read_alignments[key], function(d) {return d[5]});
    if (max_read_depth < max_contig_read_depth) {
        max_read_depth = max_contig_read_depth
    }
    var max_contig_contig_depth = d3.max(contig_alignments[key], function(d) {return d[2]})
    if (max_contig_depth < max_contig_contig_depth) {
        max_contig_depth = max_contig_contig_depth
    }
    
    contig_domains[key] = [d3.min(read_alignments[key], function(d) {return d[0]; }),
                           d3.max(read_alignments[key], function(d) {return d[3]; }) ]
}

var $table = $('#table')
$(function() {
  $table.bootstrapTable({data: contigs})
})

function mq_opacity(mq) { return mq/60 }

function plot_contig_alignments(contig_alignments, contig_alignments_svg, contig_alignments_dim, domain) {

    // contig_alignments:
    // 0 begin
    // 1 end
    // 2 contig name

    contig_alignments_dim.xscale.domain(domain)
    
    contig_alignments_svg.selectAll("line.contig_alignment").remove()
    
    var ca = contig_alignments_svg.selectAll("line.contig_alignment")
        .data(contig_alignments)
        .enter()
    
    ca.append("line")
        .attr("class", "contig_alignment")
        .attr("x1", function(d) { return contig_alignments_dim.xscale(d[0]); })
        .attr("x2", function(d) { return contig_alignments_dim.xscale(d[1]); })
        .attr("y1", function(d) { return contig_alignments_dim.yscale(d[2]); })
        .attr("y2", function(d) { return contig_alignments_dim.yscale(d[2]); })
        .style("stroke", "black")
}

function plot_read_alignments(contig_read_alignments, read_alignments_svg, read_alignments_dim, domain) {

    // contig_read_alignments:
    //  0 read start including left clip
    //  1 contig alignment start
    //  2 contig alignment end
    //  3 read end including right clip
    //  4 mapping quality
    //  5 y position on plot

    read_alignments_dim.xscale.domain(domain)
    
    read_alignments_svg.selectAll("line.read_alignment").remove()
    
    var alignments = read_alignments_svg.selectAll("line.read_alignment")
        .data(contig_read_alignments)
        .enter()
    
    alignments.append("line")
        .attr("class", "read_alignment")
        .attr("x1", function(d) { return read_alignments_dim.xscale(d[1]); })
        .attr("x2", function(d) { return read_alignments_dim.xscale(d[2]); })
        .attr("y1", function(d) { return read_alignments_dim.yscale(d[5]); })
        .attr("y2", function(d) { return read_alignments_dim.yscale(d[5]); })
        .style("stroke-opacity", function(d) { return mq_opacity(d[4]) })
        .style("stroke", "blue")

    alignments.append("line")
        .attr("class", "read_alignment")
        .attr("x1", function(d) { return read_alignments_dim.xscale(d[0]); })
        .attr("x2", function(d) { return read_alignments_dim.xscale(d[1]); })
        .attr("y1", function(d) { return read_alignments_dim.yscale(d[5]); })
        .attr("y2", function(d) { return read_alignments_dim.yscale(d[5]); })
        .style("stroke-opacity", function(d) { return mq_opacity(d[4]) })
        .style("stroke", "orange")

    alignments.append("line")
          .attr("class", "read_alignment")
          .attr("x1", function(d) { return read_alignments_dim.xscale(d[2]); })
          .attr("x2", function(d) { return read_alignments_dim.xscale(d[3]); })
          .attr("y1", function(d) { return read_alignments_dim.yscale(d[5]); })
          .attr("y2", function(d) { return read_alignments_dim.yscale(d[5]); })
          .style("stroke-opacity", function(d) { return mq_opacity(d[4]) })
          .style("stroke", "pink")
}

function select_contig(selected_contig, contigs_svg, contigs_dim) {
    var selected = contigs_svg.selectAll("circle.selected")
                    .data(contigs.filter(c => c.longname == selected_contig), function(d) { return d.longname })
    selected.enter()
        .append("circle")
        .attr("class", "selected")
        .attr("cx", contigs_dim.width + contigs_dim.margin.right/2)
        .attr("cy", function(d) { return contigs_dim.yscale(d.name) + contigs_dim.yscale.bandwidth()/2; })
        .attr("r", contigs_dim.yscale.bandwidth())
        .attr("fill", "green")

    selected.exit()
        .remove()
}

var contigs_dim = {
    margin: {top: 20, right: 20, bottom: 50, left: 80},
    height: contigs.length * 20
}

contigs_dim.width = 1000 - contigs_dim.margin.left - contigs_dim.margin.right


var read_alignments_dim = {
    margin: {top: 20, right: 20, bottom: 0, left: 80},
    height: 400
}

var contig_alignments_dim = {
    margin: {top: 0, right: 20, bottom: 50, left: 80},
    height: 100
}

single_contig_width = 1500
read_alignments_dim.width = single_contig_width - read_alignments_dim.margin.left - read_alignments_dim.margin.right
contig_alignments_dim.width = single_contig_width - contig_alignments_dim.margin.left - contig_alignments_dim.margin.right

contigs_dim.xscale = d3.scaleLinear()
                       .domain([0, d3.max(contigs, function(d) { return d.length; })])
                       .range([0, contigs_dim.width]);

contigs_dim.yscale = d3.scaleBand()
                       .domain(contigs.map(d => d.name))
                       .rangeRound([0, contigs_dim.height])
                       .padding(0.8);

contigs_dim.ploidyscale = d3.scaleSequential(d3.interpolateGreens);

read_alignments_dim.xscale = d3.scaleLinear()
                       .range([0, read_alignments_dim.width]);

read_alignments_dim.yscale = d3.scaleLinear()
                       .domain([0, max_read_depth])
                       .range([read_alignments_dim.height, 0]);

contig_alignments_dim.xscale = d3.scaleLinear()
                             .range([0, contig_alignments_dim.width]);

contig_alignments_dim.yscale = d3.scaleLinear()
                             .domain([0, max_contig_depth])
                             .range([0, contig_alignments_dim.height]);

contig_alignments_dim.colscale = d3.scaleOrdinal(d3.interpolateWarm)
                                .domain([0, 100])

var contigs_svg = d3.select("#contig_length_plot")
            .append("svg")
            .attr("width", contigs_dim.width + contigs_dim.margin.left + contigs_dim.margin.right)
            .attr("height", contigs_dim.height + contigs_dim.margin.top + contigs_dim.margin.bottom)
            .append("g")
            .attr("transform", "translate(" + contigs_dim.margin.left + "," + (contigs_dim.margin.top + contigs_dim.height) + ")")
            .call(d3.axisBottom(contigs_dim.xscale))
            .attr("class", "xAxis")
            .append("g")
            .attr("transform", "translate(0,-" + contigs_dim.height + ")")
            .call(d3.axisLeft(contigs_dim.yscale))
            .attr("class", "yAxis");

var read_alignments_svg = d3.select("#read_alignment_plot")
            .append("svg")
            .attr("width", read_alignments_dim.width)
            .attr("height", read_alignments_dim.height);

var contig_alignments_svg = d3.select("#contig_alignment_plot")
            .append("svg")
            .attr("width", contig_alignments_dim.width)
            .attr("height", contig_alignments_dim.height)

var selected_contig = contigs.map(d => d.longname)[0]
plot_read_alignments(read_alignments[selected_contig], read_alignments_svg, read_alignments_dim, contig_domains[selected_contig])
plot_contig_alignments(contig_alignments[selected_contig], contig_alignments_svg, contig_alignments_dim, contig_domains[selected_contig])

var contig_groups = contigs_svg.selectAll("g.contig")
    .data(contigs, function(d) { return d.name })
    .enter()
    .append("g")
    .attr("class", "contig")
    .attr("name", function(d) { return d.name })
    .attr("longname", function(d) { return d.longname })
    .attr("length", function(d) { return d.length })
    .on("click", function() {
        selected_contig = d3.select(this).attr("longname")
        plot_read_alignments(read_alignments[selected_contig], read_alignments_svg, read_alignments_dim, contig_domains[selected_contig])
        plot_contig_alignments(contig_alignments[selected_contig], contig_alignments_svg, contig_alignments_dim, contig_domains[selected_contig])
        select_contig(selected_contig, contigs_svg, contigs_dim)
    })
    .each(build_contig)

function build_contig(p, i, nodes) {
    var contig = d3.select(this)

    contig.append("rect")
        .attr("y", function(d) { return contigs_dim.yscale(d.name); })
        .attr("height", contigs_dim.yscale.bandwidth())
        .attr("x", 0)
        .attr("width", function(d) { return contigs_dim.xscale(d.length); })
        .attr("fill", "grey")

    contig.selectAll("rect.ploidy")
        .data(ploidys[contig.attr("longname")])
        .enter()
        .append("rect")
        .attr("class", "ploidy")
        .attr("y", function(d) { return contigs_dim.yscale(contig.attr("name")); })
        .attr("height", contigs_dim.yscale.bandwidth())
        .attr("x", function(d, i) { return contigs_dim.xscale(i*(windowsize/2)); }) // windowsize/2 because they are sliding
        .attr("width", function(d, i) { return contigs_dim.xscale(d3.min([windowsize, contig.attr("length") - i*(windowsize/2)])) })
        .attr("fill", function(d) { return contigs_dim.ploidyscale(d/5); })
        .attr("stroke-opacity", 0)

    contig.append("circle")
        .attr("class", "starttel")
        .attr("cx", 0)
        .attr("cy", function(d) { return contigs_dim.yscale(d.name) + contigs_dim.yscale.bandwidth()/2; })
        .attr("r", contigs_dim.yscale.bandwidth())
        .attr("fill", "red")
        .attr("opacity", function(d) {return (d.tel_start > 0) ? 1 : 0})
    
    contig.append("circle")
        .attr("class", "endtel")
        .attr("cx", function(d) { return contigs_dim.xscale(d.length) })
        .attr("cy", function(d) { return contigs_dim.yscale(d.name) + contigs_dim.yscale.bandwidth()/2; })
        .attr("r", contigs_dim.yscale.bandwidth())
        .attr("fill", "red")
        .attr("opacity", function(d) {return (d.tel_end > 0) ? 1 : 0})
}

select_contig(selected_contig, contigs_svg, contigs_dim)

</script>
</body>
</html>
